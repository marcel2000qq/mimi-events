<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mimi Events</title>
  <link rel="icon" type="image/x-icon" href="./favicon.ico">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.5/main.min.css" rel="stylesheet">
 <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.5/main.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const BASE_URL = '/api';

    function showNotification(message, type) {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      document.body.appendChild(notification);
      setTimeout(() => notification.remove(), 3000);
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
      anchor.addEventListener('click', function (e) {
        e.preventDefault();
        const target = document.querySelector(this.getAttribute('href'));
        if (target) target.scrollIntoView({ behavior: 'smooth' });
      });
    });

    const calendarEl = document.getElementById('calendar');
    let calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      locale: 'ro',
      initialDate: new Date(),
      validRange: { start: new Date() },
      headerToolbar: { left: 'prev,next today', center: '', right: 'title' },
      height: 'auto',
      contentHeight: 400,
      dayMaxEvents: true,
      selectable: true,
      selectAllow: function(selectInfo) {
        return selectInfo.start >= new Date();
      },
      events: [],
      dateClick: function(info) {
        handleDateSelection(info.dateStr);
      },
      datesSet: async function(info) {
        const start = info.startStr;
        const end = info.endStr;
        console.log('Fetching range:', start, end);
        try {
          const response = await fetch(`${BASE_URL}/check/range?start=${start}&end=${end}`);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const contentType = response.headers.get('content-type');
          if (!contentType || !contentType.includes('application/json')) {
            throw new Error('Răspunsul serverului nu este JSON valid');
          }
          const data = await response.json();
          console.log('Received data from server:', data);
          calendar.getEvents().forEach(event => event.remove());

          const days = document.querySelectorAll('.fc-daygrid-day');
          days.forEach(day => {
            const date = day.getAttribute('data-date');
            const item = data.find(d => d.date === date);
            const countSpan = day.querySelector('.reservation-count');
            if (countSpan) countSpan.remove();

            if (item) {
              const countSpan = document.createElement('span');
              countSpan.className = 'reservation-count';
              countSpan.textContent = `(${item.count})`;
              day.querySelector('.fc-daygrid-day-number').appendChild(countSpan);

              day.classList.remove('fc-day-full', 'fc-day-partial', 'fc-day-free');
              if (item.count >= 4) {
                day.classList.add('fc-day-full');
                calendar.addEvent({
                  title: 'Complet',
                  start: item.date,
                  allDay: true,
                  backgroundColor: '#4A7043',
                  borderColor: '#4A7043',
                  display: 'background'
                });
              } else if (item.count > 0) {
                day.classList.add('fc-day-partial');
                calendar.addEvent({
                  title: `${item.count} rezervări`,
                  start: item.date,
                  allDay: true,
                  backgroundColor: '#F5F5DC',
                  borderColor: '#F5F5DC',
                  display: 'background'
                });
              } else {
                day.classList.add('fc-day-free');
                calendar.addEvent({
                  title: 'Liber',
                  start: item.date,
                  allDay: true,
                  backgroundColor: '#90ee90',
                  borderColor: '#90ee90',
                  display: 'background'
                });
              }
            }
          });
          calendar.render();
        } catch (error) {
          console.error('Error fetching calendar data:', error.message);
          showNotification('Eroare la conectarea la server. Calendarul funcționează offline.', 'error');
        }
      }
    });

    async function handleDateSelection(dateStr) {
      console.log('Selected date:', dateStr);
      try {
        const date = new Date(dateStr);
        if (date < new Date().setHours(0, 0, 0, 0)) {
          showNotification('Nu poți selecta o dată din trecut!', 'error');
          return;
        }
        const formattedDate = moment(dateStr).format('D MMMM YYYY');
        const dateForServer = moment(dateStr).format('YYYY-MM-DD');
        const response = await fetch(`${BASE_URL}/check/${dateForServer}`);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          throw new Error('Răspunsul serverului nu este JSON valid');
        }
        const data = await response.json();
        console.log('Check result for date:', data);

        if (data.count >= 4) {
          showNotification(`Ziua ${formattedDate} este complet rezervată! Alege altă dată.`, 'error');
          return;
        }

        document.getElementById('booking-date').value = formattedDate;
        calendar.getEvents().forEach(event => event.remove());
        calendar.addEvent({
          title: 'Rezervare selectată',
          start: dateStr,
          allDay: true,
          backgroundColor: '#4A7043',
          borderColor: '#4A7043',
          display: 'background'
        });
        calendar.render();
        document.getElementById('calendar-container').style.display = 'none';
      } catch (error) {
        console.error('Error checking date:', error.message);
        showNotification('Eroare la selectarea datei. Încearcă din nou.', 'error');
      }
    }

    calendar.render();

    const bookingDateInput = document.getElementById('booking-date');
    const calendarContainer = document.getElementById('calendar-container');

    bookingDateInput.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      calendarContainer.style.display = 'block';
      calendar.gotoDate(new Date());
      calendar.render();
    });

    bookingDateInput.addEventListener('touchstart', function(e) {
      e.preventDefault();
      e.stopPropagation();
      calendarContainer.style.display = 'block';
      calendar.gotoDate(new Date());
      calendar.render();
    });

    document.addEventListener('click', function(e) {
      if (!bookingDateInput.contains(e.target) && !calendarContainer.contains(e.target)) {
        calendarContainer.style.display = 'none';
      }
    });

    document.addEventListener('touchstart', function(e) {
      if (!bookingDateInput.contains(e.target) && !calendarContainer.contains(e.target)) {
        calendarContainer.style.display = 'none';
      }
    });

    const form = document.querySelector('.booking-form');
    form.addEventListener('submit', async function(e) {
      e.preventDefault();
      const phone = form.querySelector('#phone').value.trim();
      const displayDate = form.querySelector('#booking-date').value || 'Nu a fost selectată';
      const dateForServer = displayDate !== 'Nu a fost selectată' ? moment(displayDate, 'D MMMM YYYY').format('YYYY-MM-DD') : '';
      const name = form.querySelector('#name').value.trim() || 'Fără nume';
      const email = form.querySelector('#email').value.trim();
      const eventType = form.querySelector('#event_type').value || 'Fără tip';
      const details = form.querySelector('#details').value.trim() || 'Fără detalii';

      if (!phone || !displayDate || displayDate === 'Nu a fost selectată') {
        showNotification('Te rugăm să completezi numărul de telefon și să selectezi o dată.', 'error');
        return;
      }

      if (!/\+[0-9]{2}[0-9]{9}/.test(phone)) {
        showNotification('Numărul de telefon trebuie să fie în formatul +40712 345 678.', 'error');
        return;
      }

      if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        showNotification('Te rugăm să introduci un e-mail valid sau să lași câmpul gol.', 'error');
        return;
      }

      try {
        const response = await fetch(`${BASE_URL}/check/${dateForServer}`);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          throw new Error('Răspunsul serverului nu este JSON valid');
        }
        const data = await response.json();
        if (data.count >= 4) {
          showNotification(`Ziua ${displayDate} este complet rezervată! Te rugăm să alegi altă dată.`, 'error');
          return;
        }

        const reserveResponse = await fetch(`${BASE_URL}/reserve`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ date: dateForServer, name, email, phone, eventType, details })
        });
        if (!reserveResponse.ok) {
          throw new Error(`HTTP error! status: ${reserveResponse.status}`);
        }

        showNotification('Cererea ta a fost trimisă! Îți vom contacta în curând pentru confirmare.', 'success');
        form.reset();
        calendar.getEvents().forEach(event => event.remove());
        calendarContainer.style.display = 'block';
        calendar.render();
      } catch (error) {
        console.error('Error submitting reservation:', error.message);
        showNotification('Eroare la trimiterea cererii. Înce
</body>
</html>
